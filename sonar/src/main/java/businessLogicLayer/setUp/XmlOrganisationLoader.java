package businessLogicLayer.setUp;

import businessLogicLayer.sonar.IOpaBlackBoard;
import businessLogicLayer.sonar.OpaBlackBoard;
import dataAccessLayer.agents.IOpa;
import dataAccessLayer.IProtocol;
import dataAccessLayer.Protocol;
import dataAccessLayer.SonarOrganisation;
import dataAccessLayer.tasks.*;
import xmlRawClasses.*;
import xmlRawClasses.Task;

import javax.xml.bind.JAXBContext;
import javax.xml.bind.JAXBException;
import javax.xml.bind.Unmarshaller;
import java.io.File;
import java.util.ArrayList;
import java.util.List;
import java.util.logging.Logger;

/**
 * Created by Daniel Hofmeister on 04.01.2016.
 */
public class XmlOrganisationLoader implements IOrganisationLoader {

  private static final Logger logger = Logger.getLogger(XmlOrganisationLoader.class.getName());

  public SonarOrganisation loadOrganisation(String filepath) {
    Organisation result = null;
    try {
      JAXBContext jaxbContext = JAXBContext.newInstance(Organisation.class);
      Unmarshaller jaxbUnmarshaller = jaxbContext.createUnmarshaller();
      result = (Organisation) jaxbUnmarshaller.unmarshal(new File(filepath));
      System.out.println(result);
    } catch (JAXBException e) {
      e.printStackTrace();
    }
    return organisationConverter(result);
  }

  /**
   * Converts an autogenerated xml Organisation into an actual Sonar Organisation.
   * @param xmlOrg XML parsed representation of an organisation
   * @return internal usable representation of an organisation.
   */
  public SonarOrganisation organisationConverter(Organisation xmlOrg) {
    SonarOrganisation result = new SonarOrganisation();
    // Transfer all protocols
    List<IProtocol> protocols = new ArrayList<>();
    for (xmlRawClasses.Protocol p : xmlOrg.getProtocol()) {
      Protocol protocol = new Protocol(p.getName(), p.getRole(), p.getFile());
      protocols.add(protocol);
    }
    result.setProtocols(protocols);

    IOpaBlackBoard blackBoardOpas = new OpaBlackBoard();

    //Transfer Opas
    List<IOpa> opas = new ArrayList<>();
    for (Opa o : xmlOrg.getOpa()) {
      List<IEckiges> tasks = new ArrayList<>();
      //Transfer Tasks
      for (Task t : o.getTask()) {
        IEckiges task;
        List<Round> inputs;
        List<Round> outputs;
        // Convert Execs into tasks without Output
        for (Exec e : t.getExec()) {
          task = new Eckiges(Operation.EXEC,
              new Round(e.getInput().getProtocol(),e.getInput().getRole(), o.getName()), null);
          tasks.add(task);
        }
        // Convert Delegs into tasks
        for (Deleg d : t.getDeleg()) {
          inputs = new ArrayList<>();
          for (Input i : d.getInput()) {
            inputs.add(new Round(i.getProtocol(),i.getRole(), o.getName()));
          }
          outputs = new ArrayList<>();
          outputs.add(new Round(inputs.get(0).getProtocol(),inputs.get(0).getRoles(), d.getTo()));
          task = new Eckiges(Operation.DELEG, inputs.get(0), outputs);
          tasks.add(task);
        }
        // Convert Refine into tasks
        for (Refine r : t.getRefine()) {
          outputs = new ArrayList<>();
          outputs.add(new Round(r.getOutput().getProtocol(),r.getOutput().getRole(), o.getName()));
          task = new Eckiges(Operation.REFINE,
              new Round(r.getInput().getProtocol(),r.getInput().getRole(),o.getName()), outputs);
          tasks.add(task);
        }
        // Convert Split into tasks
        for (Split s : t.getSplit()) {
          outputs = new ArrayList<>();
          for (Output out : s.getOutput()) {
            outputs.add(new Round(out.getProtocol(), out.getRole(), o.getName()));
          }
          task = new Eckiges(Operation.SPLIT,
              new Round(s.getInput().getProtocol(),s.getInput().getRole(), o.getName()), outputs);
          tasks.add(task);
        }
      }

      IOpa opa = new dataAccessLayer.agents.Opa(null,o.getName(),tasks, o.getResource(),
          o.getCommunicationProtocol(), blackBoardOpas);
      blackBoardOpas.registerOpa(opa);
      // TODO find a more clever way to determine starting tasks
      if (opa.getId().equals("O1")) {
        List<String> rol = new ArrayList<>();
        rol.add("landlord");
        rol.add("smarthome");
        opa.addStartTask(new Round("arrangeCelebration",rol,"O1"));
      }
      opas.add(opa);
    }
    result.setAllOpas(opas);
    return result;
  }
}
